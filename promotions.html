<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Jam Circle Promotions Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script> 
    <style>
        :root {
            --color-purple-primary: rgb(75, 0, 130);
            --color-purple-light: rgb(123, 50, 180);
            --color-white: rgb(255, 255, 255);
            --color-off-white: rgb(248, 249, 250);
            --color-dark-text: rgb(33, 37, 41);
            --color-grey-text: rgb(108, 117, 125);
            --color-input-border: rgb(206, 212, 218);
            --color-google-blue: #4285F4; 
            --color-google-red: #DB4437; 
        }

        body {
            font-family: 'Montserrat', sans-serif;
            font-weight: 400;
            background-color: var(--color-purple-primary);
            color: var(--color-white);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.6;
        }

        .container { max-width: 1200px; margin: 1rem auto; padding: 1rem; }
        .form-section, .output-section { background-color: var(--color-off-white); color: var(--color-dark-text); padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); margin-bottom: 2rem; }
        
        h1, h2 { font-family: 'Montserrat', sans-serif; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; color: var(--color-purple-primary); margin-bottom: 1.5rem; }
        h1 { font-size: 2.2rem; text-align: center; color: var(--color-white); margin-bottom: 2rem; }
        h2 { font-size: 1.6rem; } 
        h3.section-subtitle { font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 1.4rem; color: var(--color-dark-text); margin-top: 1.5rem; margin-bottom: 1rem; }
        h4.social-platform-title { font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 1.1rem; color: var(--color-purple-light); margin-top: 1rem; margin-bottom: 0.5rem; }

        label { display: block; margin-bottom: 0.5rem; font-weight: 700; color: var(--color-dark-text); }
        input[type="text"], input[type="date"], input[type="file"], textarea { width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid var(--color-input-border); border-radius: 4px; font-family: 'Montserrat', sans-serif; font-size: 1rem; background-color: var(--color-white); color: var(--color-dark-text); }
        input[type="file"] { padding: 0.5rem; }
        #selectedFilesDisplay { font-size: 0.85rem; color: var(--color-grey-text); margin-top: -0.5rem; margin-bottom: 1rem; min-height: 20px;}
        textarea { min-height: 80px; }

        .button-base { padding: 0.85rem 1.5rem; border: none; border-radius: 50px; font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 1rem; text-transform: uppercase; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; display: block; width: 100%; margin-top: 0.75rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2); text-align: center; }
        .generate-button { background-color: var(--color-purple-primary); color: var(--color-white); margin-top: 1.5rem; }
        .generate-button:hover { background-color: var(--color-purple-light); transform: translateY(-2px); }
        
        .google-button { margin-top: 0.5rem; font-size: 0.9rem; padding: 0.7rem 1.2rem;}
        .google-drive-button { background-color: var(--color-google-blue); color: var(--color-white); }
        .google-drive-button:hover { background-color: #3a78d8; }
        .google-photos-button { background-color: var(--color-google-red); color: var(--color-white); }
        .google-photos-button:hover { background-color: #c73a2f; }


        /* Poster Styles */
        .poster-preview-container { margin-top: 2rem; }
        .poster-container { max-width: 600px; margin: 0 auto; border: none; background-color: var(--color-purple-primary); color: var(--color-white); box-shadow: 0 5px 25px rgba(0,0,0,0.2); border-radius: 10px; overflow: hidden; padding: 2rem; text-align: center; }
        .poster-header-title { font-family: 'Montserrat', sans-serif; font-weight: 400; text-transform: uppercase; letter-spacing: 1px; color: var(--color-off-white); font-size: 1.5rem; margin-bottom: 0.5rem; }
        .poster-event-name-title { font-family: 'Montserrat', sans-serif; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; color: var(--color-white); font-size: 2.8rem; line-height: 1.2; margin-top: 0; margin-bottom: 1.5rem; }
        .poster-tagline-text { font-family: 'Montserrat', sans-serif; color: var(--color-off-white); font-style: normal; font-weight: 400; font-size: 1.1rem; margin-bottom: 2rem; }
        .poster-image-section { margin-top: 1.5rem; margin-bottom: 2rem; background-color: var(--color-purple-light); border-radius: 8px; padding: 10px; min-height: 200px; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; }
        .poster-collage-image { max-width: calc(50% - 10px); max-height: 200px; border-radius: 4px; object-fit: cover; border: 2px solid var(--color-white); }
        .poster-collage-image.count-1 { max-width: 90%; max-height: 300px;}
        .poster-collage-image.count-2 { max-width: calc(50% - 10px); max-height: 200px;}
        .poster-collage-image.count-3 { max-width: calc(33.33% - 10px); max-height: 150px;}
        .poster-collage-image.count-4 { max-width: calc(50% - 10px); max-height: 180px;}
        .poster-collage-image.count-gt-4 { max-width: calc(33.33% - 10px); max-height: 130px;}
        .poster-details-text p, .poster-ticket-info p { font-family: 'Montserrat', sans-serif; color: var(--color-white); font-weight: 400; font-size: 1.1rem; margin-bottom: 0.75rem; }
        .poster-details-text strong { font-weight: 700; }
        .poster-cta-button { font-family: 'Montserrat', sans-serif; background-color: var(--color-white); color: var(--color-purple-primary); padding: 0.75rem 1.8rem; border: none; border-radius: 50px; text-decoration: none; font-weight: 700; display: inline-block; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 1.5rem; font-size: 1rem; transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease; }
        .poster-cta-button:hover { background-color: var(--color-off-white); color: var(--color-purple-light); transform: scale(1.05); }
        .poster-footer p { font-family: 'Montserrat', sans-serif; color: var(--color-off-white); font-weight: 400; font-size: 0.9rem; margin-top: 1rem; }
        
        /* Social Media Output */
        .social-media-item { margin-bottom: 2rem; background-color: var(--color-white); padding: 1rem; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
        .social-image-preview { max-width: 180px; max-height: 135px; border: 1px solid var(--color-input-border); margin-bottom: 0.75rem; object-fit: cover; border-radius: 4px; display: block; }
        .social-output-text { margin-top: 0.5rem; padding: 1rem; background-color: var(--color-off-white); border: 1px solid var(--color-input-border); border-radius: 4px; white-space: pre-wrap; font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 0.85rem; max-height: 250px; overflow-y: auto; color: var(--color-dark-text); }
        .social-note { font-size: 0.8rem; color: var(--color-grey-text); margin-top: 0.75rem; font-style: italic; line-height: 1.4; }
        
        @media (min-width: 768px) { .form-output-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 2rem; } .form-section { margin-bottom: 0; } }
        @media (min-width: 1024px) { .form-output-grid { grid-template-columns: 450px 1fr; } }
    </style>
</head>
<body>

    <div class="container">
        <h1>Jam Circle Promotions Generator</h1>

        <div class="form-output-grid">
            <div class="form-section">
                <h2>Event Details</h2>
                <form id="eventForm">
                    <div>
                        <label for="eventName">Event Name:</label>
                        <input type="text" id="eventName" name="eventName" value="Galway Jam Circle" required>
                    </div>
                    <div>
                        <label for="venue">Venue:</label>
                        <input type="text" id="venue" name="venue" value="The Crane Bar" required>
                    </div>
                    <div>
                        <label for="eventDate">Event Date:</label>
                        <input type="date" id="eventDate" name="eventDate" required>
                    </div>
                    <div>
                        <label for="eventTime">Event Time:</label>
                        <input type="text" id="eventTime" name="eventTime" value="Every Wednesday, 8 PM" required>
                    </div>
                    <div>
                        <label for="tagline">Short Description/Theme:</label>
                        <input type="text" id="tagline" name="tagline" value="All welcome! Bring your instruments & good vibes.">
                    </div>
                    
                    <div>
                        <label>Upload Images:</label>
                        <input type="file" id="imageFiles" name="imageFiles" multiple accept="image/*" style="margin-bottom: 0.5rem;">
                        <button type="button" id="googleDriveButton" class="button-base google-drive-button" disabled>Select from Google Drive</button>
                        <button type="button" id="googlePhotosButton" class="button-base google-photos-button" disabled>Select from Google Photos</button>
                        <div id="selectedFilesDisplay">No images selected. (Google buttons will enable after API loads & you sign in)</div>
                    </div>

                    <div>
                        <label for="features">Featured Instruments/Genres (comma-separated):</label>
                        <textarea id="features" name="features" placeholder="Acoustic, Folk, Trad, Blues, Guitars, Fiddles, Bodhráns"></textarea>
                    </div>
                    <div>
                        <label for="ticketInfo">Entry/Cover Charge:</label>
                        <input type="text" id="ticketInfo" name="ticketInfo" value="Free Entry / Donation based">
                    </div>
                    <div>
                        <label for="contactInfo">Contact Info (Optional):</label>
                        <input type="text" id="contactInfo" name="contactInfo" value="galwayjam@example.com">
                    </div>
                    <button type="button" class="generate-button button-base" onclick="generatePromotions()">Generate Promotions</button>
                </form>
            </div>

            <div class="output-section">
                <h2>Generated Promotions</h2>
                <div id="posterOutput" class="poster-preview-container">
                    <h3 class="section-subtitle">Poster Preview</h3>
                    <div class="poster-container" id="posterContainerContent">
                        <p style="color: var(--color-white);">Enter details and click "Generate" to see the poster.</p>
                    </div>
                </div>
                <div id="socialMediaOutputSection">
                    <h3 class="section-subtitle">Social Media Posts</h3>
                    <div id="socialMediaContent">
                        <p style="color: var(--color-dark-text);">Press "Generate" to see social media post suggestions.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- IMPORTANT NOTE FOR GOOGLE PICKER API ---
        // This file MUST be served via a web server (e.g., GitHub Pages, local server).
        // It WILL NOT WORK if opened directly as a file:/// URL.
        // Ensure API_KEY, CLIENT_ID are correct & "Authorized JavaScript origins" in Google Cloud Console match.
        // --- END IMPORTANT NOTE ---

        // --- USER CONFIGURATION REQUIRED ---
        const API_KEY = 'AIzaSyA2_4BP7Qv6JYIONCg2KJ6upr2VbaNojkw'; 
        const CLIENT_ID = '786809892671-cpohg98fo9vuf75756qgp0lc4laq43ka.apps.googleusercontent.com'; 
        // --- END USER CONFIGURATION ---

        const DRIVE_SCOPE = 'https://www.googleapis.com/auth/drive.readonly';
        const PHOTOS_SCOPE = 'https://www.googleapis.com/auth/photoslibrary.readonly'; 
        
        let gapiPickerLoaded = false; 
        let gisInited = false;  
        let tokenClient; 
        let currentAccessToken = null; 
        let selectedImageUrls = []; 

        console.log("Script start - GIS Auth Refined & Full Promo Text"); 

        function gapiLibraryLoadCallback() {
            console.log("gapiLibraryLoadCallback called (GAPI script loaded)");
            gapi.load('picker', onPickerApiLoad); 
        }

        function onPickerApiLoad() {
            console.log("onPickerApiLoad called (Picker API module loaded)");
            gapiPickerLoaded = true;
            checkEnablePickerButtons(); 
        }
        
        function gisLibraryLoadCallback() {
            console.log("gisLibraryLoadCallback (Google Identity Services SCRIPT loaded)");
            if (CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com' || API_KEY === 'YOUR_GOOGLE_API_KEY') {
                 alert("CLIENT_ID or API_KEY is not set in the script. Please replace placeholders."); return;
            }
            try {
                google.accounts.id.initialize({
                    client_id: CLIENT_ID,
                    callback: handleGisCredentialResponse, 
                });
                console.log("Google Identity Services initialized (google.accounts.id.initialize)");
                gisInited = true;

                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: `${DRIVE_SCOPE} ${PHOTOS_SCOPE}`, 
                    callback: (tokenResponse) => { 
                        if (tokenResponse && tokenResponse.access_token) {
                            currentAccessToken = tokenResponse.access_token;
                            console.log("GIS Access Token obtained via tokenClient:", currentAccessToken ? "Yes" : "No");
                            enablePickerButtons(true);
                        } else {
                            currentAccessToken = null;
                            enablePickerButtons(false);
                            console.error("GIS Token Response error or no access_token:", tokenResponse);
                        }
                    },
                    error_callback: (error) => {
                        console.error("GIS initTokenClient error_callback:", JSON.stringify(error, Object.getOwnPropertyNames(error)), error);
                        currentAccessToken = null;
                        enablePickerButtons(false);
                        // Avoid alerting for common pop-up issues during silent attempts
                        if (error.type !== 'popup_failed_to_open' && error.type !== 'popup_closed_by_user' && error.type !== 'session_timed_out_or_revoked') {
                           // alert("Error during Google authorization process. Check console."); 
                        }
                    }
                });
                // Do not call tokenClient.requestAccessToken({prompt: 'none'}); here.
                // Let user interaction (button click) or handleGisCredentialResponse trigger it.
                checkEnablePickerButtons(); 
            } catch (error) {
                 console.error("Error initializing Google Identity Services (GIS):", error);
                 alert("Critical error initializing Google Sign-In services. Check console.");
            }
        }
        
        function handleGisCredentialResponse(response) {
            console.log("GIS handleCredentialResponse :", response);
            if (response.credential) { 
                console.log("ID Token received (indicates sign-in). Requesting access token for Picker.");
                requestAccessTokenForPicker('consent'); 
            } else {
                console.log("GIS Credential response does not contain credential.");
                 enablePickerButtons(false); 
            }
        }

        function requestAccessTokenForPicker(promptType = 'consent') {
            if (tokenClient) {
                console.log(`Requesting access token for Picker (prompt: ${promptType})...`);
                tokenClient.requestAccessToken({prompt: promptType}); 
            } else {
                console.error("Token client not initialized for Picker token request.");
                alert("Google authentication not ready. Please wait or refresh the page.");
            }
        }

        function enablePickerButtons(enable) {
            document.getElementById('googleDriveButton').disabled = !enable;
            document.getElementById('googlePhotosButton').disabled = !enable;
            const filesDisplay = document.getElementById('selectedFilesDisplay');
            if (enable && currentAccessToken) { 
                 if(filesDisplay.textContent.includes('Sign in to Google') || filesDisplay.textContent.includes('No images selected') || filesDisplay.textContent.includes('Initializing')) {
                    filesDisplay.textContent = 'No images selected. Google services ready.';
                }
            } else {
                if(filesDisplay.textContent.includes('Google services ready') || filesDisplay.textContent.includes('No images selected')) {
                     filesDisplay.textContent = 'No images selected. (Sign in to Google or allow pop-ups if prompted)';
                }
            }
        }

        function checkEnablePickerButtons() {
            if (gapiPickerLoaded && gisInited && tokenClient) {
                console.log("Picker API and GIS ready. Buttons enabled. Token will be requested on click if needed.");
                enablePickerButtons(true); 
            } else {
                console.log(`Picker buttons not enabled yet. gapiPickerLoaded: ${gapiPickerLoaded}, gisInited: ${gisInited}`);
                enablePickerButtons(false);
            }
        }
        
        function createPicker(type) {
            console.log("createPicker called for type:", type); 
            if (!gapiPickerLoaded) {
                alert("Google Picker API not loaded yet. Please wait and try again.");
                return;
            }
            if (!gisInited || !tokenClient) {
                alert("Google Authentication not ready. Please wait or refresh the page.");
                return;
            }

            if (!currentAccessToken) {
                console.log("No current access token for Picker. Requesting with consent...");
                requestAccessTokenForPicker('consent'); 
                alert("Please complete the Google sign-in/consent process. If a pop-up doesn't appear, check your browser's pop-up blocker. Then, try clicking the Google Drive/Photos button again after authorization.");
                return;
            }
            
            console.log("Proceeding to createPickerView with token:", currentAccessToken ? "Yes" : "No");
            createPickerView(type);
        }

        function createPickerView(type) {
            console.log("createPickerView called for type:", type); 
            let view;
            let title = 'Select Images';
            if (type === 'drive') {
                title = 'Select an image from Google Drive';
                view = new google.picker.View(google.picker.ViewId.DOCS_IMAGES);
            } else if (type === 'photos') {
                title = 'Select from Google Photos';
                view = new google.picker.View(google.picker.ViewId.PHOTOS);
            } else { console.error("Unknown picker type:", type); return; }

            const picker = new google.picker.PickerBuilder()
                .setAppId(CLIENT_ID.split('.')[0]) 
                .setOAuthToken(currentAccessToken) 
                .addView(view)
                .setDeveloperKey(API_KEY) 
                .setCallback(pickerCallback)
                .setTitle(title)
                .setMaxItems(6 - document.getElementById('imageFiles').files.length) 
                .build();
            picker.setVisible(true);
            console.log("Picker should be visible now."); 
        }

        function pickerCallback(data) {
            console.log("pickerCallback data:", data); 
            try {
                if (data[google.picker.Response.ACTION] == google.picker.Action.PICKED) {
                    const docs = data[google.picker.Response.DOCUMENTS];
                    console.log("Picked documents:", docs); 
                    docs.forEach(doc => {
                        let imageUrl = doc.url; 
                        if (!imageUrl && doc.thumbnails && doc.thumbnails.length > 0) {
                            imageUrl = doc.thumbnails[doc.thumbnails.length - 1].url;
                            if (imageUrl) imageUrl = imageUrl.replace(/=s\d+(-c)?$/, '=s0'); 
                        }
                        if (doc.serviceId === 'photos' && imageUrl && !imageUrl.endsWith('-d')) {
                             console.log("Google Photos URL picked:", imageUrl);
                        }

                        if (imageUrl && !selectedImageUrls.includes(imageUrl)) {
                            selectedImageUrls.push(imageUrl);
                        } else if (!imageUrl) {
                            console.warn("Could not get a usable image URL from picker for doc:", doc);
                        }
                    });
                    updateSelectedFilesDisplay();
                } else if (data[google.picker.Response.ACTION] == google.picker.Action.CANCEL) {
                    console.log('Google Picker Canceled');
                }
            } catch (error) {
                 console.error("Error in pickerCallback:", error);
            }
        }
        
        function updateSelectedFilesDisplay() {
            const localFiles = Array.from(document.getElementById('imageFiles').files);
            const display = document.getElementById('selectedFilesDisplay');
            let fileNames = [];
            localFiles.forEach(file => fileNames.push(`Local: ${file.name.substring(0,20)}...`));
            const validSelectedImageUrls = selectedImageUrls.filter(url => url);
            validSelectedImageUrls.forEach((url, index) => {
                let name = `Cloud Image ${index + 1}`;
                try {
                    const urlObj = new URL(url);
                    const pathParts = urlObj.pathname.split('/');
                    const potentialName = pathParts[pathParts.length -1];
                    if (potentialName && potentialName.length > 3) { name = potentialName; }
                } catch (e) { /* ignore */ }
                fileNames.push(`Cloud: ${name.substring(0,30)}...`);
            });
            if (fileNames.length > 0) {
                display.textContent = `${fileNames.length} image(s) selected: ${fileNames.join('; ')}`;
            } else {
                 if (gisInited && tokenClient) { 
                    display.textContent = 'No images selected. Google services ready.';
                } else {
                    display.textContent = 'No images selected. (Initializing Google services...)';
                }
            }
             console.log("Updated selected files display:", display.textContent); 
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOMContentLoaded event"); 
            
            window.gapiLoadCallback = gapiLibraryLoadCallback; 
            window.gisLoadCallback = gisLibraryLoadCallback;   

            const gapiScriptTag = document.createElement('script');
            gapiScriptTag.src = 'https://apis.google.com/js/api.js?onload=gapiLoadCallback';
            gapiScriptTag.async = true;
            gapiScriptTag.defer = true;
            document.head.appendChild(gapiScriptTag);

            const gisScript = document.querySelector('script[src="https://accounts.google.com/gsi/client"]');
            if (gisScript) {
                if (typeof google !== 'undefined' && google.accounts) {
                    console.log("GIS script likely already loaded, calling gisLoadCallback directly.");
                    gisLibraryLoadCallback(); 
                } else {
                    gisScript.onload = gisLibraryLoadCallback; 
                }
            } else {
                console.error("GIS script tag not found! This is unexpected.");
            }


            try {
                const today = new Date();
                let nextWednesday = new Date(today);
                const dayOfWeek = today.getDay();
                let daysUntilWednesday = (3 - dayOfWeek + 7) % 7;
                if (daysUntilWednesday === 0 && today.getHours() >= 12) { 
                    daysUntilWednesday = 7; 
                }
                nextWednesday.setDate(today.getDate() + daysUntilWednesday);
                
                console.log("Before<y_bin_46> calculation. nextWednesday is:", nextWednesday.toString()); 
                const<y_bin_46> = nextWednesday.getFullYear(); 
                console.log("After<y_bin_46> calculation.<y_bin_46> is:",<y_bin_46>); 

                const mm = String(nextWednesday.getMonth() + 1).padStart(2, '0');
                const dd = String(nextWednesday.getDate()).padStart(2, '0');
                const dateInput = document.getElementById('eventDate');
                if (dateInput) {
                    dateInput.value = `${yyyy}-${mm}-${dd}`; 
                } else {
                    console.error("Element with ID 'eventDate' not found.");
                }
                
                const featuresInput = document.getElementById('features');
                if (featuresInput) {
                    featuresInput.value = "Acoustic, Folk, Trad, Blues, Guitars, Fiddles, Bodhráns";
                } else {
                     console.error("Element with ID 'features' not found.");
                }

                const imageFilesInput = document.getElementById('imageFiles');
                if (imageFilesInput) {
                    imageFilesInput.addEventListener('change', updateSelectedFilesDisplay);
                } else {
                    console.error("Element with ID 'imageFiles' not found.");
                }
            } catch (e) {
                console.error("Error specifically within DOMContentLoaded's date logic or element access:", e);
                const selectedFilesDisplay = document.getElementById('selectedFilesDisplay');
                if (selectedFilesDisplay) {
                    selectedFilesDisplay.textContent = 'Error in page setup. Check console.';
                }
            }
            console.log("DOMContentLoaded event - END"); 
        });

        function formatDate(dateStr) { 
            if (!dateStr) return "TBC";
            try {
                const dateObj = new Date(dateStr + 'T00:00:00');
                return dateObj.toLocaleDateString('en-IE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            } catch (e) { console.error("Error formatting date:", e); return dateStr; }
        }

        function escapeForHTML(str) {
            if (typeof str !== 'string') return str;
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#039;')
                      .replace(/`/g, '&#96;');
        }

        async function generatePromotions() {
            console.log("generatePromotions function called - START (Full Functionality)"); 
            try {
                const details = {
                    eventName: document.getElementById('eventName').value || "Galway Jam Circle",
                    venue: document.getElementById('venue').value || "A Friendly Pub",
                    date_str_input: document.getElementById('eventDate').value,
                    time_str: document.getElementById('eventTime').value || "8 PM",
                    tagline: document.getElementById('tagline').value || "Join us for a night of music!",
                    features_raw: document.getElementById('features').value, 
                    ticket_info: document.getElementById('ticketInfo').value || "Free Entry",
                    contact_info: document.getElementById('contactInfo').value
                };
                
                const escapedDetails = {
                    eventName: escapeForHTML(details.eventName),
                    venue: escapeForHTML(details.venue),
                    time_str: escapeForHTML(details.time_str),
                    tagline: escapeForHTML(details.tagline),
                    ticket_info: escapeForHTML(details.ticket_info),
                    contact_info: escapeForHTML(details.contact_info),
                    date_str: formatDate(details.date_str_input) 
                };

                const featuresArray = details.features_raw ? details.features_raw.split(',').map(f => f.trim()).filter(f => f) : [];
                escapedDetails.features = featuresArray.length > 0 ? featuresArray.map(f => escapeForHTML(f)) : ["All genres welcome", "Friendly atmosphere", "BYO Instrument"];
                
                console.log("Details collected and escaped:", escapedDetails); 

                const localImageFiles = document.getElementById('imageFiles').files;
                const localImagePromises = [];
                const maxCollageImages = 6; 
                for (let i = 0; i < localImageFiles.length; i++) {
                    const file = localImageFiles[i];
                    localImagePromises.push(new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (event) => resolve(event.target.result);
                        reader.onerror = (error) => reject(error);
                        reader.readAsDataURL(file);
                    }));
                }
                let localImageDataUrls = [];
                try { localImageDataUrls = await Promise.all(localImagePromises); } 
                catch (error) { console.error("Error reading local image files:", error); }

                const allImageUrls = [...new Set([...localImageDataUrls, ...selectedImageUrls.filter(url=>url)])]; 
                const finalCollageUrls = allImageUrls.slice(0, maxCollageImages);
                console.log("Final collage URLs:", finalCollageUrls); 


                let posterPrimaryImageUrlForSocial = finalCollageUrls.length > 0 ? finalCollageUrls[0] : '';
                const defaultEventNamePlaceholder = encodeURIComponent(escapedDetails.eventName.substring(0,25).replace(/\s+/g, '+'));
                if (!posterPrimaryImageUrlForSocial) { 
                     posterPrimaryImageUrlForSocial = `https://placehold.co/800x600/4B0082/FFFFFF?text=${defaultEventNamePlaceholder}&font=montserrat`;
                }
                const fallbackImageUrl = `https://placehold.co/800x600/6A0DAD/FFFFFF?text=Image+Not+Found&font=montserrat`;

                let collageHtml = '';
                if (finalCollageUrls.length > 0) {
                    const imgCountClass = `count-${finalCollageUrls.length > 4 ? 'gt-4' : finalCollageUrls.length}`;
                    finalCollageUrls.forEach(dataUrl => {
                        collageHtml += `<img src="${escapeForHTML(dataUrl)}" alt="Collage image for ${escapedDetails.eventName}" class="poster-collage-image ${imgCountClass}" onerror="this.src='${fallbackImageUrl}';">`;
                    });
                } else {
                    collageHtml = `<img src="${escapeForHTML(posterPrimaryImageUrlForSocial) || fallbackImageUrl}" alt="Placeholder for ${escapedDetails.eventName}" class="poster-collage-image count-1">`;
                }
                console.log("Collage HTML generated"); 


                const posterHtml = `
                    <header style="margin-bottom: 1rem;">
                        <h1 class="poster-header-title">Open Music Session</h1>
                        <h2 class="poster-event-name-title">${escapedDetails.eventName}</h2>
                        <p class="poster-tagline-text">"${escapedDetails.tagline}"</p>
                    </header>
                    <section class="poster-image-section" id="posterCollageContainer">
                        ${collageHtml}
                    </section>
                    <section class="poster-details-text" style="margin-bottom: 1.5rem;">
                        <p><strong style="font-weight: 700;">WHERE:</strong> ${escapedDetails.venue}, Galway</p>
                        <p><strong style="font-weight: 700;">WHEN:</strong> ${escapedDetails.date_str}</p>
                        <p><strong style="font-weight: 700;">TIME:</strong> ${escapedDetails.time_str}</p>
                    </section>
                    <section class="poster-ticket-info" style="margin-bottom: 1.5rem;">
                        <p>${escapedDetails.ticket_info}</p>
                        ${escapedDetails.ticket_info.toLowerCase().includes("free") ? '' : '<a href="#" class="poster-cta-button">More Info</a>'}
                    </section>
                    <footer class="poster-footer" style="padding-top: 1rem;">
                        <p>Bring your instruments, voice, or just come to listen!</p>
                        ${escapedDetails.contact_info ? `<p style="margin-top: 0.25rem;">Contact: ${escapedDetails.contact_info}</p>` : ''}
                    </footer>`;
                document.getElementById('posterContainerContent').innerHTML = posterHtml;
                console.log("Poster HTML injected"); 

                const socialMediaContentEl = document.getElementById('socialMediaContent');
                socialMediaContentEl.innerHTML = ''; 
                const imageCopyInstructions = "<strong>To use images:</strong> For the poster, take a screenshot. For social media, upload your chosen image(s) directly. You can right-click/long-press on individual images in the collage preview to save them.";
                const commonHashtags = `#GalwayJamCircle #GalwayMusic #LiveMusicGalway #OpenMicGalway #GalwayEvents #CommunityMusic #${(escapedDetails.venue || "GalwayVenue").replace(/\s+/g, "")}`;
                const socialPreviewImageUrl = escapeForHTML(posterPrimaryImageUrlForSocial) || fallbackImageUrl;

                // --- Restored Social Media Text Generation ---
                console.log("Generating Instagram text...");
                const featuresListInsta = escapedDetails.features.slice(0, 3).map(f => `- ${f}`).join("\n");
                const instagramText = 
`**${escapedDetails.eventName} is ON!**

"${escapedDetails.tagline}"

Join us for a fantastic session of live music & community vibes.
${featuresListInsta ? `\nFeaturing:\n${featuresListInsta}\n` : ''}
**Where:** ${escapedDetails.venue}, Galway
**When:** ${escapedDetails.date_str}
**Time:** ${escapedDetails.time_str}
**Entry:** ${escapedDetails.ticket_info}

Bring your friends, instruments, and good energy!
${commonHashtags}`;
                console.log("Instagram text created:", instagramText.substring(0,100) + "..."); 

                const instagramDiv = document.createElement('div');
                instagramDiv.className = 'social-media-item';
                instagramDiv.innerHTML = `<h4 class="social-platform-title">Instagram Post:</h4><img src="${socialPreviewImageUrl}" alt="Preview" class="social-image-preview" onerror="this.style.display='none';"><div class="social-output-text"></div><p class="social-note">${imageCopyInstructions}</p>`;
                instagramDiv.querySelector('.social-output-text').textContent = instagramText.trim();
                socialMediaContentEl.appendChild(instagramDiv);
                console.log("Instagram post HTML injected."); 

                console.log("Generating Facebook text...");
                const featuresBulletsFb = escapedDetails.features.map(f => `- ${f}`).join("\n");
                const facebookText = 
`**${escapedDetails.eventName} - Join the Jam!**

"${escapedDetails.tagline}"

Get ready for a great night of music and fun at ${escapedDetails.venue}! Whether you play, sing, or just love live music, come on down.

${featuresBulletsFb ? `**What to expect:**\n${featuresBulletsFb}\n` : ''}
**Date:** ${escapedDetails.date_str}
**Time:** ${escapedDetails.time_str}
**Venue:** ${escapedDetails.venue}, Galway
**Entry:** ${escapedDetails.ticket_info}

${escapedDetails.contact_info ? `For more info, contact: ${escapedDetails.contact_info}\n` : ''}
Share with your music-loving friends! Let's make some noise!
${commonHashtags}`;
                console.log("Facebook text created:", facebookText.substring(0,100) + "...");

                const facebookDiv = document.createElement('div');
                facebookDiv.className = 'social-media-item';
                facebookDiv.innerHTML = `<h4 class="social-platform-title">Facebook Post:</h4><img src="${socialPreviewImageUrl}" alt="Preview" class="social-image-preview" onerror="this.style.display='none';"><div class="social-output-text"></div><p class="social-note">${imageCopyInstructions}</p>`;
                facebookDiv.querySelector('.social-output-text').textContent = facebookText.trim();
                socialMediaContentEl.appendChild(facebookDiv);
                console.log("Facebook post HTML injected.");
            
                console.log("Generating Twitter text...");
                const shortTaglineTwitter = escapedDetails.tagline.length > 60 ? escapedDetails.tagline.substring(0, 57) + "..." : escapedDetails.tagline;
                const twitterText = 
`Jammin' in Galway!
**${escapedDetails.eventName}**
"${shortTaglineTwitter}"
At: ${escapedDetails.venue}
On: ${escapedDetails.date_str}, ${escapedDetails.time_str}
Entry: ${escapedDetails.ticket_info}
${commonHashtags.split(' ').slice(0,4).join(' ')} #Galway`;
                console.log("Twitter text created:", twitterText.substring(0,100) + "...");
                
                const twitterDiv = document.createElement('div');
                twitterDiv.className = 'social-media-item';
                twitterDiv.innerHTML = `<h4 class="social-platform-title">Twitter (X) Post:</h4><img src="${socialPreviewImageUrl}" alt="Preview" class="social-image-preview" onerror="this.style.display='none';"><div class="social-output-text"></div><p class="social-note">${imageCopyInstructions}</p>`;
                twitterDiv.querySelector('.social-output-text').textContent = twitterText.trim();
                socialMediaContentEl.appendChild(twitterDiv);
                console.log("Twitter post HTML injected.");

                selectedImageUrls = []; 
                console.log("generatePromotions function finished successfully."); 
            } catch (error) {
                console.error("Error in generatePromotions:", error);
                alert("An error occurred while generating promotions. Please check the console for details.");
            }
        }
        console.log("Script end"); 
    </script>

</body>
</html>
